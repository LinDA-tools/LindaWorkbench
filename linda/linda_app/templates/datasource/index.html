{% extends "base.html" %}
{% load url from future %}
{% load i18n thumbnail2 %}
{% load app_filters %}
{% block title %}{% trans "Data Sources"%} | LinDA{% endblock %}
{% block bodyclass %}datasource-create{% endblock %}

{% block content %}
<div class="main">
    <h2 class="datasource-index-title">{% trans "Data Sources" %}</h2><a href="/datasource/create">+ {%trans "Create New"%}</a>
        <div class="right" style="margin-right: 40px;">
            {% trans "Sort by" %}:
            {% with field=sortBy id="sortBy" options=sortOptions default="{{sort_default}}" small="true"%}
                {% include 'util/prettydropdown.html' %}
            {% endwith %}
        </div>
    {% if datasources %}
        <table class="datasources-table">
            <thead>
                <tr>
                    <th>{% trans "Name" %}</th>
                    <th>{% trans "Type" %}</th>
                    <th>{% trans "SparQL Endpoint"%}</th>
                    <th>{% trans "Created" %}</th>
                    <th>{% trans "Last modified" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for datasource in datasources %}
                    <tr id="{{datasource.name}}" class="datasource {% if datasource.is_public %}public{% else %}private{% endif %}">
                        <td><img src="/static/images/rdf.png" width="15px"/> {{datasource.title}}</td>
                        {% if datasource.is_public %}
                            <td>{% trans "Public" %}</td>
                            <td>{{datasource.uri}}</td>
                        {% else %}
                            <td>{% trans "Private" %}</td>
                            <td></td>
                        {% endif %}
                        <td>{{datasource.createdOn}}</td>
                        <td>{{datasource.lastUpdateOn}}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>{% trans "No datasource found."%}</p>
    {% endif %}
</div>

{% endblock %}

{% block scripts %}
    {% with field=sortBy id="sortBy" %}
        {% include 'util/prettydropdown_js.html' %}
    {% endwith %}

    <link rel="stylesheet" href="/static/css/jquery.contextMenu.css" />
    <script src="/static/js/jquery.contextMenu.js"></script>
    <script>
        $( "#id_sortBy" ).on('change', (function() {
            window.location = "/datasources/?sort=" + $(this).val();
        }));

        function downloadWithName(uri, name) {
            var link = document.createElement("a");
            link.download = name;
            link.href = uri;
            document.getElementById("main-container").appendChild(link);
            link.click();
            link.parentNode.removeChild(link);
        }

 $(function(){ //private datasource context menu

            $.contextMenu({
                selector: '.datasource.private',
                callback: function(key, options) {
                    var id = options.$trigger.attr('id');
                    var url;

                    if (key == "Visualize")
                        url = "/visualize/datasource/" + id;
                    else
                    if (key == "Edit")
                        url = "/datasource/" + id + "/replace/";
                    else
                    if (key == "Delete")
                        url = "/datasource/" + id + "/delete/";
                    else
                    if (key == "Download") {
                        url = "/datasource/" + id + "/download/";
                        downloadWithName(url, id + ".rdf");
                        return
                    }

                    $(this).addClass("show-context-menu");
                    if (url)
                        window.location = url;
                },
                items: {
                    "Visualize": {name: "Visualize", icon: "visualize"},
                    "Explore / View": {name: "Explore", icon: "explore"},
                    "sep1": "---------",
                    "Edit": {name: "Edit", icon: "edit"},
                    "Delete": {name: "Delete", icon: "delete"},
                    "sep2": "---------",
                    "Open": {name: "Open", icon: "open"},
                    "Download": {name: "Download", icon: "download"},
                }
            });

            $.contextMenu({ //public datasource context menu
                selector: '.datasource.public',
                callback: function(key, options) {
                    var id = options.$trigger.attr('id');
                    var url;

                    if (key == "Visualize")
                        url = "/visualize/datasource/" + id;
                    else
                    if (key == "Analyze")
                        url = "/analyze/datasource/" + id;
                    else
                    if (key == "Edit")
                        url = "/datasource/" + id + "/replace/";
                    else
                    if (key == "Delete")
                        url = "/datasource/" + id + "/delete/";

                    $(this).addClass("show-context-menu");
                    if (url)
                        window.location = url;
                },
                items: {
                    "Visualize": {name: "Visualize", icon: "visualize"},
                    "Analyze": {name: "Analyze", icon: "analyze"},
                    "Explore / View": {name: "Explore", icon: "explore"},
                    "sep1": "---------",
                    "Edit": {name: "Edit", icon: "edit"},
                    "Delete": {name: "Delete", icon: "delete"},

                }
            });
        });
    </script>
{% endblock %}
