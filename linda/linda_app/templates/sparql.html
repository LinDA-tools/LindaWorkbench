{% extends "base.html" %}
{% block title %}SparQL Endpoint | LinDa{% endblock %}
{% block bodyclass %}sparql{% endblock %}
{% load app_filters %}
{% load i18n %}

{%block css %}
    <link rel="stylesheet" src="/static/css/query-builder.css" />
    <link rel="stylesheet" src="/static/css/bootstrap.min.css" />

    <link data-turbolinks-track="true" href="/static/query-builder/stylesheets/_variables.css?body=1" media="all" rel="stylesheet" />
    <link data-turbolinks-track="true" href="/static/query-builder/stylesheets/bootstrap.css?body=1" media="all" rel="stylesheet" />
    <link data-turbolinks-track="true" href="/static/query-builder/stylesheets/bootstrap.min.css?body=1" media="all" rel="stylesheet" />
    <link data-turbolinks-track="true" href="/static/query-builder/stylesheets/common.css?body=1" media="all" rel="stylesheet" />
    <link data-turbolinks-track="true" href="/static/query-builder/stylesheets/developer.css?body=1" media="all" rel="stylesheet" />
    <link data-turbolinks-track="true" href="/static/query-builder/stylesheets/query.css?body=1" media="all" rel="stylesheet" />
    <link data-turbolinks-track="true" href="/static/query-builder/stylesheets/application.css?body=1" media="all" rel="stylesheet" />
    <link data-turbolinks-track="true" href="/static/query-builder/stylesheets/gritter.css?body=1" media="all" rel="stylesheet" />
{% endblock %}


{% block content %}
<div class="main sparql">
    <h1 class="page-title">SparQL Endpoint{% if query %} - Edit Query{% endif %}</h1>

    <div>
        <div class="dropdown clear-dataset">
            <button class="btn btn-default dropdown-toggle clear-dataset col-md-12" type="button" id="dd_select_dataset"
                    data-toggle="dropdown">
                Choose a Data Source&nbsp;
                <span class="caret"></span>
            </button>
            <ul class="dropdown-menu col-md-12" role="menu" aria-labelledby="dd_select_dataset">
                {% for datasource in datasources %}
                    <li role="presentation"><a role="menuitem" tabindex="-1"
                                           onclick="select_dataset('{{datasource.name}}', '{{datasource | get_endpoint}}');">{{datasource.title}}</a>
                    </li>
                {% endfor %}
            </ul>
        </div>
        {% with hidden_value_id="hdn_qb_dataset" div_classes="done-dataset" div_id="div_select_dataset" remove_function="QueryBuilder.datasets.reset()" hidden_value_value="" %}
            {% include 'query-builder/selector.html' %}
        {% endwith %}
    </div>

    <div class="main-container panel panel-default">
        <div class="panel-body">

            <div class="row">

                <div class="col-md-12">
                    {% with query=query %}
                        {% include 'query-builder/sparql-query-editor.html' %}
                    {% endwith %}
                </div>
            </div>

            {% include 'query-builder/search-results.html' %}

            <input type="hidden" id="hdn_qb_dataset" value="">
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script>
        rdf2any_server = "{{RDF2ANY_SERVER}}";
	</script>

    <script data-turbolinks-track="true" src="/static/query-builder/javascripts/jquery_ujs.js?body=1"></script>
    <script data-turbolinks-track="true" src="/static/query-builder/javascripts/turbolinks.js?body=1"></script>
    <script data-turbolinks-track="true" src="/static/query-builder/javascripts/bootstrap.js?body=1"></script>
    <script data-turbolinks-track="true" src="/static/query-builder/javascripts/bootstrap.min.js?body=1"></script>
    <script data-turbolinks-track="true" src="/static/query-builder/javascripts/developer.js?body=1"></script>
    <script data-turbolinks-track="true" src="/static/query-builder/javascripts/query.js?body=1"></script>
    <script data-turbolinks-track="true" src="/static/query-builder/javascripts/resources/common.js?body=1"></script>
    <script data-turbolinks-track="true" src="/static/query-builder/javascripts/resources/querybuilder.js?body=1"></script>
    <script data-turbolinks-track="true" src="/static/query-builder/javascripts/resources/sparql.js?body=1"></script>
    <script data-turbolinks-track="true" src="/static/query-builder/javascripts/resources/utilities.js?body=1"></script>
    <script data-turbolinks-track="true" src="/static/query-builder/javascripts/codemirror.js?body=1"></script>
    <script data-turbolinks-track="true" src="/static/query-builder/javascripts/gritter.js?body=1"></script>
    <script data-turbolinks-track="true" src="/static/query-builder/javascripts/application.js?body=1"></script>

    <script>
        jQuery(function () {
            jQuery('.dropdown-toggle').dropdown();
        });
        jQuery("#txt_search_classes").bind('input',function(){QueryBuilder.search_classes_change();});

        function select_dataset(dtn, endp) {
            dt_name = dtn;
            endpoint_uri = endp;
            $('#dd_select_dataset').html(dt_name);
            $('#hdn_qb_dataset').val(endpoint_uri);
        }

            function save_query() {
                $.ajax({
                    {% if query %}
                        url: "/query-builder/save/{{query.id}}/",
                    {% else %}
                        url: "/query-builder/save/",
                    {% endif %}
                    type: "POST",
                    data: {
                        endpoint: endpoint_uri,
                        endpointName: dt_name,
                        query: $("#txt_sparql_query").val(),
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function(data, textStatus, jqXHR)
                    {
                        document.location.href = '/queries/';
                    },
                    error: function (jqXHR, textStatus, errorThrown)
                    {
                        alert(textStatus + ': ' + errorThrown);
                    }
                });
            }

    </script>

    {% if query %}
        <script>
            /*Select the predefined datasource if it's specified*/
            dt_name = '{{query.endpoint}}';
            {% for datasource in datasources %}
                {% if datasource|get_endpoint == query.endpoint %}
                    dt_name = '{{datasource.name}}';
                {% endif %}
            {% endfor %}
            select_dataset(dt_name, '{{query.endpoint}}');
        </script>
    {% endif %}

    <script src="/static/js/ace/src/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="/static/js/ace/src/mode-sparql.js" type="text/javascript" charset="utf-8"></script>
    <script src="/static/js/ace/src/ext-language_tools.js" type="text/javascript" charset="utf-8"></script>
    <script>
        jQuery(function () {
            var langTools = ace.require("ace/ext/language_tools");
            editor = ace.edit("txt_sparql_query");
            editor.setTheme("ace/theme/monokai");
            editor.setShowPrintMargin(false);
            editor.getSession().setUseWrapMode(true);

            var SparqlMode = require("ace/mode/sparql").Mode;
            editor.getSession().setMode(new SparqlMode());

            ace.config.loadModule("ace/ext/language_tools", function() {
                editor.setOptions({
                    enableSnippets: true,
                    enableBasicAutocompletion: true
                });
            });

            //add autocomplete for prefixes
            var SparQLCompleter = {
                getCompletions: function(editor, session, pos, prefix, callback) {
                    if (prefix.length === 0) { callback(null, []); return }

                    var token = editor.session.getTokenAt(pos.row, pos.column - prefix.length - 1);  //get previous token

                    var in_vocabulary = '';
                    var vocab_prefix = '';
                    if (token.type == "sparql.prefix.constant.language") { //search classes or properties inside a vocabulary
                        vocab_prefix = token.value;
                        in_vocabulary += '&prefix=' + token.value.split(":")[0];
                        token = editor.session.getTokenAt(pos.row, token.start - 1); //get the previous token
                        console.log(in_vocabulary);
                        console.log(token);
                    }

                    var val = token.value.toLowerCase()
                    if (val == "prefix") { //suggest vocabularies
                        $.getJSON(
                        "/coreapi/recommend/?vocabulary=" + prefix,
                        function(vocabularyList) {
                            callback(null, vocabularyList.map(function(v) {
                                return {caption: v.vocabulary, name: v.vocabulary, value: v.prefix + ": <" + v.uri + ">\n", score: v.ranking, meta: "Vocabulary"}
                            }));
                        })
                    }
                    else if ((val == "a") || (val == "type")) { //suggest classes
                        $.getJSON(
                        "/coreapi/recommend/?class=" + prefix + in_vocabulary,
                        function(classList) {
                            callback(null, classList.map(function(c) {
                                return {caption: c.label, name: c.label, value: c.uri + ' ', score: c.ranking, meta: c.vocabulary}
                            }));
                        })
                    } else if ((token.type == "sparql.variable") || (token.type == "sparql.constant.uri")) { //suggest properties
                        $.getJSON(
                        "/coreapi/recommend/?property=" + prefix + in_vocabulary,
                        function(propertyList) {
                            callback(null, propertyList.map(function(p) {
                                return {caption: p.label, name: p.label, value: p.uri + ' ', score: p.ranking, meta: p.vocabulary}
                            }));
                        })
                    }
                }
            }
            langTools.addCompleter(SparQLCompleter);
        });
    </script>
{% endblock %}
