{% extends "base.html" %}

{% block content %}
    <div class="main">
        <div class="response-time" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
        <div class="response-time-avg" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="/static/js/highcharts/highcharts.js"></script>
    <script src="/static/js/highcharts/exporting.js"></script>

    <script>
    function getKeys(obj){
        var keys = [];
        for (key in obj) {
            if (obj.hasOwnProperty(key)) { keys[keys.length] = key; }
        }
        return keys;
    }
    </script>

    <script>
    var metrics = [];
    var dt_name;
    var exec_time, resp_time;

    {% for test in tests %}
        dt_name = '{{test.datasource.name}}';
        if (metrics[dt_name] === undefined) {
            metrics[dt_name] = [];
        }

        exec_time = Date.UTC({{test.execution_time.year}}, {{test.execution_time.month}} - 1,  {{test.execution_time.day}});
        exec_time += {{test.execution_time.hour}}*3600*1000 + {{test.execution_time.minute}}*60*1000 + {{test.execution_time.second}}*1000;

        {% if test.up %}
            resp_time = {{test.response_time}}/1000.0;
        {% else %}
            resp_time = null;
        {% endif %}

        metrics[dt_name].push([exec_time, resp_time]);
    {% endfor %}

    //get all keys in the array
    var names = getKeys(metrics);
    var series = [];
    var series_avg = [];
    var colors = [];
    for (var i=0; i<names.length; i++) {
        series[i] = {name: names[i], data: []};
        colors[i] = "#"+((1<<24)*Math.random()|0).toString(16);
        var sum = 0, n_of_samples = 0;

        for (var j=0; j<metrics[names[i]].length; j++) {
            var v = metrics[names[i]][j];
            series[i].data.push(v);
            if (v[1] != null) {
                sum += v[1];
                n_of_samples++;
            }
        }

        //calculate the average response time of each endpoint
        series_avg[i] = {name : names[i]};
        if (n_of_samples > 0) {
            series_avg[i].data = [Math.round(sum/n_of_samples*100)/100.0];
        } else {
            series_avg[i].data = null;
        }
    }

    $(function () {
        //response time over time chart
        $('.response-time').highcharts({
            chart: {
                type: 'spline',
                zoomType: 'xy'
            },
            title: {
                text: 'Remote endpoint response times'
            },
            xAxis: {
                type: 'datetime',
                title: {
                    text: 'Date'
                }
            },
            yAxis: {
                title: {
                    text: 'Response time (sec)'
                },
                min: 0
            },
            tooltip: {
                headerFormat: '<b>{series.name}</b><br>',
                pointFormat: '{point.x:%e. %b}: {point.y:.2f} sec'
            },
            colors: colors,
            plotOptions: {
                spline: {
                    marker: {
                        enabled: false
                    }
                }
            },

            series: series
        });

        //average response time chart
        $('.response-time-avg').highcharts({
            chart: {
                type: 'bar'
            },
            title: {
                text: "Average response time"
            },
            xAxis: {
                title: {
                    text: "Endpoint"
                },
                labels: {
                    enabled:false,//default is true
                }
            },
            yAxis: {
                title: {
                    text: "Time (sec)"
                }
            },
            colors: colors,
            tooltip: {
                headerFormat: ''
            },
            series: series_avg
        });

    });
    </script>
{% endblock %}